
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PeerShare â€” P2P Transfer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to right, #0f172a, #1e293b);
      color: #f1f5f9;
    }
    .glass {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .btn {
      background: rgba(255,255,255,0.07);
      transition: all 0.2s ease-in-out;
    }
    .btn:hover {
      background: rgba(255,255,255,0.15);
    }
    .loader {
      border: 4px solid rgba(255,255,255,0.2);
      border-top: 4px solid #f8fafc;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4 py-8">
  <div class="glass rounded-xl shadow-xl w-full max-w-xl p-8 space-y-6">
    <h1 class="text-3xl font-bold text-center text-white">PeerShare</h1>
    <p class="text-center text-sm text-gray-400">Secure P2P Chat & File Transfer</p>

    <div id="roleUI" class="flex flex-col gap-4">
      <button onclick="startSend()" class="btn rounded-lg px-4 py-2 w-full text-white">ðŸ“¤ Send</button>
      <button onclick="startReceive()" class="btn rounded-lg px-4 py-2 w-full text-white">ðŸ“¥ Receive</button>
    </div>

    <div id="sendUI" class="hidden space-y-4 text-center">
      <p class="text-gray-300 text-sm">Share this room code</p>
      <div id="roomCode" class="text-2xl font-mono tracking-widest px-4 py-2 bg-gray-800 inline-block rounded-md"></div>
      <div id="qrcode" class="mx-auto"></div>
      <p class="text-xs text-gray-400 mt-2">Waiting for peer to connect...</p>
      <div class="loader mx-auto"></div>
    </div>

    <div id="receiveUI" class="hidden space-y-3">
      <input id="roomInput" placeholder="Enter Room Code" class="w-full px-4 py-2 rounded text-black" />
      <button onclick="joinRoom()" class="btn w-full rounded-lg px-4 py-2 text-white">ðŸ”— Join</button>
    </div>

    <div id="chatUI" class="hidden space-y-3">
      <div id="connectionStatus" class="text-xs text-green-400">ðŸŸ¢ Connected</div>
      <div id="chat" class="bg-gray-800 rounded p-3 h-48 overflow-y-auto text-sm flex flex-col gap-2"></div>
      <input id="message" placeholder="Message..." class="w-full px-3 py-2 text-black rounded" />
      <input type="file" id="fileInput" class="w-full text-sm text-gray-400" />
      <div class="flex gap-2">
        <button class="btn flex-1 rounded px-3 py-2 text-white" onclick="sendText()">ðŸ’¬ Send</button>
        <button class="btn flex-1 rounded px-3 py-2 text-white" onclick="sendFile()">ðŸ“Ž Send File</button>
      </div>
    </div>
  </div>

<script>
let socket, pc, channel;
let roomCode = "", isInitiator = false;
const fileChunks = {}, chunkSize = 32 * 1024;
const $ = id => document.getElementById(id);

function startSend() {
  isInitiator = true;
  roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
  $("roomCode").textContent = roomCode;
  new QRCode("qrcode", { text: roomCode, width: 128, height: 128 });
  show("sendUI");
  connect();
}

function startReceive() {
  show("receiveUI");
}

function joinRoom() {
  roomCode = $("roomInput").value.trim().toUpperCase();
  if (roomCode) { isInitiator = false; connect(); }
}

function show(id) {
  ["roleUI", "sendUI", "receiveUI", "chatUI"].forEach(x => $(x).classList.add("hidden"));
  $(id).classList.remove("hidden");
}

function connect() {
  socket = new WebSocket("wss://webrtc-node-0s89.onrender.com");
  socket.onopen = () => socket.send(JSON.stringify({ type: "join", room: roomCode }));
  socket.onmessage = async e => {
    const msg = JSON.parse(e.data);
    if (msg.type === "ready") {
      await initPeer();
      if (isInitiator) {
        channel = pc.createDataChannel("chat");
        setupChannel();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.send(JSON.stringify({ type: "signal", data: offer }));
      }
    } else if (msg.type === "signal") {
      if (!pc) await initPeer();
      if (msg.data.sdp) {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
        if (msg.data.type === "offer") {
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          socket.send(JSON.stringify({ type: "signal", data: pc.localDescription }));
        }
      } else if (msg.data.candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(msg.data));
      }
    }
  };
}

async function initPeer() {
  pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
  pc.onicecandidate = e => e.candidate && socket.send(JSON.stringify({ type: "signal", data: e.candidate }));
  pc.ondatachannel = e => { channel = e.channel; setupChannel(); };
}

function setupChannel() {
  channel.onopen = () => {
    show("chatUI");
    $("connectionStatus").textContent = "âœ… Connected to peer";
    log("ðŸŸ¢ Data Channel is open", "sys");
  };
  channel.onmessage = e => {
    const data = JSON.parse(e.data);
    if (data.type === "text") log("Peer: " + data.content, "peer");
    else if (data.type === "file-chunk") receiveChunk(data);
  };
}

function sendText() {
  const msg = $("message").value.trim();
  if (msg && channel?.readyState === "open") {
    channel.send(JSON.stringify({ type: "text", content: msg }));
    log("You: " + msg, "you");
    $("message").value = "";
  }
}

function sendFile() {
  const file = $("fileInput").files[0];
  if (!file) return;
  const reader = new FileReader(), fileId = Date.now().toString();
  reader.onload = () => {
    const buf = reader.result, total = Math.ceil(buf.byteLength / chunkSize);
    for (let i = 0; i < total; i++) {
      const chunk = buf.slice(i * chunkSize, (i + 1) * chunkSize);
      const b64 = btoa(String.fromCharCode(...new Uint8Array(chunk)));
      channel.send(JSON.stringify({
        type: "file-chunk", fileId, filename: file.name,
        sequence: i, data: b64, isLast: i === total - 1
      }));
    }
    log(`ðŸ“¤ File sent: ${file.name}`, "you");
  };
  reader.readAsArrayBuffer(file);
}

function receiveChunk(data) {
  if (!fileChunks[data.fileId]) fileChunks[data.fileId] = [];
  fileChunks[data.fileId][data.sequence] = atob(data.data);
  if (data.isLast) {
    const bin = fileChunks[data.fileId].join(''), bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    const blob = new Blob([bytes]), url = URL.createObjectURL(blob);
    log(`ðŸ“¥ File received: ${data.filename}<br><a href="${url}" download="${data.filename}" class="text-blue-400 underline text-xs">Click to download</a>`, "peer");
  }
}

function log(msg, cls = "") {
  const div = document.createElement("div");
  div.className = "text-sm px-3 py-2 rounded bg-gray-700";
  if (cls === "you") div.classList.add("self-end", "bg-green-700");
  if (cls === "peer") div.classList.add("self-start", "bg-blue-700");
  div.innerHTML = msg;
  $("chat").appendChild(div);
  $("chat").scrollTop = $("chat").scrollHeight;
}
</script>
</body>
</html>
