<!DOCTYPE html>
<html>
<head>
  <title>Code-Based WebRTC Chat</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, textarea, button { width: 100%; margin: 10px 0; padding: 10px; }
    #chat { background: #f9f9f9; height: 200px; overflow-y: auto; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>

<h2>ðŸ”¢ Code-Based WebRTC Chat</h2>

<input id="roomCode" placeholder="Enter Room Code (e.g. room123)" />
<button onclick="joinRoom()">Join Room</button>

<div id="connectionStatus">Status: Not Connected</div>

<input id="message" placeholder="Type a message..." />
<button onclick="sendMessage()">Send</button>

<div id="chat">Chat log:</div>

<script>
  let socket, pc, channel;
  const chat = document.getElementById("chat");

  const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

  function log(text) {
    chat.textContent += text + "\n";
    chat.scrollTop = chat.scrollHeight;
    console.log("[chat]", text);
  }

  function joinRoom() {
    const room = document.getElementById("roomCode").value;
    if (!room) return alert("Enter a room code");

    socket = new WebSocket("wss://webrtc-node-0s89.onrender.com");

    socket.onopen = () => {
      console.log("ðŸ”Œ WebSocket connected");
      socket.send(JSON.stringify({ type: "join", room }));
      document.getElementById("connectionStatus").textContent = "Status: Joined room, waiting...";
    };

    socket.onmessage = async (event) => {
      console.log("[message received]", event.data);
      const msg = JSON.parse(event.data);

      if (msg.type === "ready") {
        console.log("âœ… Got READY â€” starting peer");
        startPeer(true);
      } else if (msg.type === "signal") {
        console.log("ðŸ“¨ Got SIGNAL");
        if (!pc) await startPeer(false);
        const signal = msg.data;

        if (signal.sdp) {
          await pc.setRemoteDescription(new RTCSessionDescription(signal));
          if (signal.type === "offer") {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.send(JSON.stringify({ type: "signal", data: pc.localDescription }));
            console.log("ðŸ“¤ Sent answer");
          }
        } else if (signal.candidate) {
          await pc.addIceCandidate(new RTCIceCandidate(signal));
          console.log("âž• Added ICE candidate");
        }
      }
    };
  }

  async function startPeer(isInitiator) {
    pc = new RTCPeerConnection(servers);

    pc.onicecandidate = e => {
      if (e.candidate) {
        socket.send(JSON.stringify({ type: "signal", data: e.candidate }));
        console.log("ðŸ“¡ Sent ICE candidate");
      }
    };

    pc.ondatachannel = e => {
      channel = e.channel;
      channel.onmessage = e => log("Peer: " + e.data);
      channel.onopen = () => {
        document.getElementById("connectionStatus").textContent = "Status: Connected âœ…";
        console.log("âœ… Data channel opened (responder)");
      };
    };

    if (isInitiator) {
      channel = pc.createDataChannel("chat");
      channel.onmessage = e => log("Peer: " + e.data);
      channel.onopen = () => {
        document.getElementById("connectionStatus").textContent = "Status: Connected âœ…";
        console.log("âœ… Data channel opened (initiator)");
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.send(JSON.stringify({ type: "signal", data: offer }));
      console.log("ðŸ“¤ Sent offer");
    }

    console.log("ðŸ”§ startPeer called | initiator =", isInitiator);
  }

  function sendMessage() {
    const msg = document.getElementById("message").value;
    if (channel && channel.readyState === "open") {
      channel.send(msg);
      log("You: " + msg);
      document.getElementById("message").value = "";
    } else {
      alert("Connection not ready yet.");
    }
  }
</script>

</body>
</html>
